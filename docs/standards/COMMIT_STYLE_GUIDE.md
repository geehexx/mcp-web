# Commit Message Style Guide

**Standard:** [Conventional Commits 1.0.0](https://www.conventionalcommits.org/en/v1.0.0/)
**Enforcement:** Pre-commit hook + CI
**Last Updated:** October 15, 2025

---

## Format

```
<type>(<scope>): <description>

[optional body]

[optional footer(s)]
```

### Components

1. **Type** (required): Category of change
2. **Scope** (optional): Area affected
3. **Description** (required): Short summary (imperative mood)
4. **Body** (optional): Detailed explanation
5. **Footer** (optional): Breaking changes, issues, etc.

---

## Types

### Primary Types

| Type | Description | Example |
|------|-------------|---------|
| `feat` | New feature | `feat(api): add query parameter filtering` |
| `fix` | Bug fix | `fix(security): validate IPv6 localhost addresses` |
| `docs` | Documentation only | `docs(api): update authentication examples` |
| `refactor` | Code change that neither fixes bug nor adds feature | `refactor(cache): simplify key building logic` |
| `test` | Adding or updating tests | `test(security): add IPv6 blocking tests` |
| `chore` | Maintenance tasks | `chore(deps): update dependencies` |

### Secondary Types

| Type | Description | Example |
|------|-------------|---------|
| `perf` | Performance improvement | `perf(chunker): optimize token counting` |
| `style` | Formatting, whitespace | `style: apply ruff formatting` |
| `build` | Build system or dependencies | `build: migrate to uv package manager` |
| `ci` | CI configuration | `ci: add parallel testing workflow` |
| `security` | Security-related changes | `security(auth): implement rate limiting` |

---

## Scopes

Use snake_case for scope names.

### Common Scopes

- **Module-level:** `cache`, `security`, `fetcher`, `extractor`, `summarizer`
- **Test-level:** `test`, `fixtures`, `benchmarks`
- **Tool-level:** `pre-commit`, `ci`, `workflow`, `deps`
- **Doc-level:** `rules`, `adr`, `api`, `guide`
- **Infrastructure:** `docker`, `deployment`, `monitoring`

---

## Description Rules

1. **Use imperative mood** ("add" not "added" or "adds")
2. **Start with lowercase** (unless proper noun)
3. **No period at end**
4. **Limit to 72 characters**
5. **Be specific** (not "fix bug" but "fix IPv6 localhost validation")

### Good Examples

✅ `fix(security): validate IPv6 localhost with brackets`
✅ `feat(cache): add TTL-based expiration`
✅ `docs(testing): document parallel test strategy`
✅ `refactor(api): extract validation logic to separate module`

### Bad Examples

❌ `fixed a bug` (not imperative, not specific)
❌ `Add new feature.` (has period, not specific)
❌ `Updated stuff` (vague)
❌ `WIP` (not descriptive)

---

## Body Guidelines

**When to include:**

- Complex changes needing explanation
- Breaking changes rationale
- Migration instructions
- Performance impact

**Format:**

- Separate from description with blank line
- Wrap at 72 characters
- Use bullet points for lists
- Explain _why_, not _what_ (code shows what)

**Example:**

```
refactor(cache): migrate from Redis to in-memory cache

- Redis dependency was heavyweight for current needs
- In-memory cache sufficient for single-instance deployment
- Reduces deployment complexity and dependencies
- Performance tests show 10x faster access times

Benchmark results:
- Redis: 2.3ms average
- In-memory: 0.2ms average
```

---

## Footer Guidelines

### Breaking Changes

**MUST** include `BREAKING CHANGE:` footer for backwards-incompatible changes.

**Alternative:** Use `!` after type/scope:

```
feat(api)!: change authentication to OAuth2

BREAKING CHANGE: API key authentication removed. All clients must migrate to OAuth2.

Migration guide: docs/migration/v2-oauth.md
```

### Issue References

Link to issues/PRs:

```
fix(security): prevent SSRF via localhost

Fixes #123
Closes #456
See also #789
```

### Co-authors

Give credit:

```
feat(summarizer): add custom prompt templates

Co-authored-by: Jane Doe <jane@example.com>
```

---

## Special Cases

### Reverting Commits

```
revert: feat(api): add endpoint pagination

This reverts commit a1b2c3d4.

Reason: Pagination implementation caused data inconsistency issues.
```

### Merge Commits

Automatically generated by Git. Don't modify unless necessary.

```
Merge pull request #123 from user/feature-branch

feat(cache): add Redis support
```

### Work in Progress (WIP)

**Avoid** committing WIP to shared branches.

If necessary for backup:

```
wip(feature): checkpoint before refactoring

DO NOT MERGE - Work in progress
```

---

## Multi-Commit Guidelines

### Atomic Commits

Each commit should be:

- **Self-contained:** Represents one logical change
- **Reversible:** Can be reverted without breaking others
- **Testable:** Tests pass after this commit

### Logical Grouping

**Example sequence:**

```bash
# Commit 1: Add feature structure
feat(api): add endpoint structure for user search

# Commit 2: Add tests
test(api): add user search endpoint tests

# Commit 3: Implement feature
feat(api): implement user search with filtering

# Commit 4: Add documentation
docs(api): document user search endpoint
```

### Squashing Commits

Before merging, squash:

- Fix commits (`fix: typo`)
- WIP commits
- Repeated iterations

Keep separate:

- Different features
- Bug fixes
- Refactorings

---

## Validation

### Pre-Commit Hook

Automatically validates commit messages:

```bash
# Install pre-commit hooks
task install:pre-commit

# Test commit message
echo "feat: add new feature" | uv run conventional-pre-commit
```

### Manual Validation

Check your last commit:

```bash
git log -1 --pretty=%B | head -1
```

Should match pattern: `^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|security)(\(.+\))?: .{1,72}$`

---

## Examples by Scenario

### Adding a Feature

```
feat(summarizer): add support for custom prompts

Users can now provide custom system prompts for summarization.

- Add `custom_prompt` parameter to `summarize()` function
- Update configuration schema to support prompt templates
- Add validation for prompt injection

Example usage:
 summarizer.summarize(text, custom_prompt="Summarize as bullet points")

Closes #234
```

### Fixing a Bug

```
fix(cache): handle None values in cache keys

Previously, passing None as a URL would cause KeyError.
Now returns None immediately for None input.

Fixes #456
```

### Refactoring

```
refactor(security): simplify URL validation logic

Extract host extraction to separate function for testability.
No functional changes.
```

### Updating Documentation

```
docs(adr): add ADR for httpx/playwright fallback strategy

Document the decision to use httpx as primary fetcher with
Playwright as fallback for JavaScript-heavy sites.

Reference: docs/adr/0001-use-httpx-playwright-fallback.md
```

### Performance Improvement

```
perf(chunker): optimize token counting with caching

Token counting for same text repeated multiple times is now cached.

Performance impact:
- Before: 150ms for 10 identical chunks
- After: 15ms for 10 identical chunks
- Memory overhead: ~50KB per unique text

Benchmark: tests/benchmarks/test_chunker_performance.py
```

### Breaking Change

```
feat(api)!: change cache key format for consistency

BREAKING CHANGE: Cache key format changed from "fetch_{url}"
to "fetch:{sha256(url)}". Existing cache entries will be invalid.

Migration:
1. Clear existing cache: `rm -rf .cache/`
2. Update code if you're building cache keys manually

Rationale: SHA256 hashing prevents issues with special characters
in URLs and provides consistent key length.
```

---

## Tooling

### Git Aliases

Add to `~/.gitconfig`:

```ini
[alias]
 # Conventional commit shortcuts
 feat = "!f() { git commit -m \"feat: $*\"; }; f"
 fix = "!f() { git commit -m \"fix: $*\"; }; f"
 docs = "!f() { git commit -m \"docs: $*\"; }; f"
 refactor = "!f() { git commit -m \"refactor: $*\"; }; f"
 test = "!f() { git commit -m \"test: $*\"; }; f"
 chore = "!f() { git commit -m \"chore: $*\"; }; f"
```

Usage:

```bash
git feat "add new feature"
# Creates: feat: add new feature
```

### VSCode Extension

Install: [Conventional Commits](https://marketplace.visualstudio.com/items?itemName=vivaxy.vscode-conventional-commits)

Provides GUI for creating conventional commits.

---

## References

- **Official Spec:** https://www.conventionalcommits.org/en/v1.0.0/
- **Angular Convention:** https://github.com/angular/angular/blob/main/CONTRIBUTING.md#commit
- **Commitlint:** https://commitlint.js.org/
- **Semantic Versioning:** https://semver.org/

---

**Enforcement:** This style guide is enforced by pre-commit hooks.
**Violations:** Will prevent commit unless `--no-verify` is used (discouraged).
